#!/usr/bin/env ruby
require 'optparse'
require 'HTTParty'
require 'rails'
require 'json'
class Rule
  attr_reader :impact, :name, :suggestion
  def initialize(opts)
    @impact      = opts['ruleImpact'].to_f
    @name        = opts['localizedRuleName']
    @suggestion  = Suggestion.new(opts['urlBlocks'])
  end

  def to_s
    "#{impact}: #{name}\n#{suggestion.to_s}"
  end
end


class Suggestion
  attr_rader :bottom_line, :more_info_at
  def initialize(arr)
    base_info_from(arr.shift['header'])
  end

  def to_s
    @arr.to_s
  end

  private

  def base_info_from(hash)
    @bottom_line  = hash['format']
    if hash.has_key?('args')
      @more_info_at = hash['args'].first['value'] if hash['args'].first['type'] == 'HYPERLINK'
    end
  end

end

class SlowPage
  API_URL='https://www.googleapis.com/pagespeedonline/v1/runPagespeed'
  attr_reader :url
  def initialize(opts)
    @url = opts[:url]
    @url = "http://#{@url}" unless @url =~ /^https?:\/\//
    @api_key = opts[:key]
  end

  def to_s
    results.to_s
  end

  def response
    @response ||= request_from_api
  end

  def parse
    rules_from hash['formattedResults']['ruleResults']
  end

  private

  attr_reader :api_key

  def request_from_api
    opts_hash = {
      query: {
        key: api_key,
        url: url,
        prettyPrint: true
      }
    }
    HTTParty.get(API_URL, opts_hash)
  end

  def body
    response.body
  end

  def hash
    JSON.parse(body)
  end

  def rules_from(input_hash)
    input_hash.map do |k, rule_hash|
      Rule.new(rule_hash)
    end.select {|rule| rule.impact > 0.0 }
  end
end

DEFAULT_KEY_LOCATION='~/.googleapi.secret'

def key_from(file)
  (File.read File.expand_path(file)).chomp
end

def opts_from_cli
  options = {}
  opt_parser = OptionParser.new do |opts|
    opts.banner = "#{$0} [options] url"

    options[:verbose] = false
    opts.on('-v', '--verbose', 'Display more information') { options[:verbose] = true }

    options[:key] = nil
    opts.on('-f FILE', '--file FILE', 'File containing Google API key') do |file|
      puts "#{file}"
      begin
        options[:key] = key_from(file)
      rescue
        puts "Could not open #{file}"
        exit
      end
    end
    options[:key] = key_from(DEFAULT_KEY_LOCATION) if (options[:key].blank?)
    opts.on('-k', '--key', 'Google API key') { |key| options[:key]}
    opts.on('-h', '--help', 'Display this screen') { puts opts ; exit }
  end

  opt_parser.parse!
  options[:url] = ARGV.pop
  abort opt_parser.to_s if options[:url].blank?
  options
end

options = opts_from_cli
slowpage = SlowPage.new(options)
puts slowpage.parse
